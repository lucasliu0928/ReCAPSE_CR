missing_perc_MIMIC3_1
colnames(MIMIC3_rawdata)
###Missing Rate for dynamic
missing_count_n_MIMIC3_2 <- sapply(MIMIC3_rawdata, function(x) sum(is.na(x)))
missing_perc_MIMIC3_2 <- round(missing_count_n_MIMIC3_2/nrow(MIMIC3_rawdata),2)
missing_perc_MIMIC3_2
mean(c(missing_perc_MIMIC3_1,missing_perc_MIMIC3_2)) #34%
length(c(missing_perc_MIMIC3_1,missing_perc_MIMIC3_2))
mean(missing_perc_MIMIC3_2)
mean(missing_perc_UK_2) #49.3% for dynamic feature
data_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/AKID_Project/Intermediate_data_Dynamic/2021_Data/0114_21_data/"
TransE_Vector <- read.csv(paste0(data_dir,"HPO_TransE_Embed_Vector.csv"))
grp1_dxes <- which(TransE_Vector["Grps"] == "Cardi") #5
grp2_dxes <- which(TransE_Vector["Grps"] == "Meta") #15
grp3_dxes <- which(TransE_Vector["Grps"] == "Blood") #4
grp4_dxes <- which(TransE_Vector["Grps"] == "Resp")  #3
View(TransE_Vector)
TransE_Vector_grp1 <- TransE_Vector[grp1_dxes,]
TransE_Vector_grp2 <- TransE_Vector[grp2_dxes,]
TransE_Vector_grp3 <- TransE_Vector[grp3_dxes,]
TransE_Vector_grp4 <- TransE_Vector[grp4_dxes,]
#Drop names and grp names
names_todrop <- c("X","HPO_name","Grps")
TransE_Vector_grp1 <- TransE_Vector_grp1[, -which(colnames(TransE_Vector_grp1) %in% names_todrop)]
TransE_Vector_grp2 <- TransE_Vector_grp2[, -which(colnames(TransE_Vector_grp2) %in% names_todrop)]
TransE_Vector_grp3 <- TransE_Vector_grp3[, -which(colnames(TransE_Vector_grp3) %in% names_todrop)]
TransE_Vector_grp4 <- TransE_Vector_grp4[, -which(colnames(TransE_Vector_grp4) %in% names_todrop)]
#Sum for  each group
TransE_Vector_sum_grp1 <- colSums(TransE_Vector_grp1)
TransE_Vector_sum_grp1
View(TransE_Vector_grp1)
TransE_Vector_grp3
TransE_Vector_grp4
TransE_Vector_grp1
TransE_Vector_grp2
nrow(TransE_Vector_grp2)
mean(c(missing_perc_MIMIC3_2)) #34.6%
#####UK Final IDs
UK_data_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/AKID_Project/Intermediate_data_Dynamic/2021_Data/0320_21_data/DL_input_data/onRRT/Hourly_interp/"
UK_Data <- read.csv(paste0(UK_data_dir , "Final_Outcome_df.csv"),stringsAsFactors = F)
UK_Final_IDs <- unique(sapply(strsplit(UK_Data$ENCNTR_ID,split = "_"), "[[", 1))
UK_Final_IDs
#### Load UK raw dynamic RRT
UK_onRRT_raw_dir <- "/Users/lucasliu/Desktop/DrChen_Projects/All_AKI_Projects/AKID_Project/Intermediate_data_Dynamic/2021_Data/0320_21_data/Original_Sample_Data/onRRT/onRRT_raw/"
UK_files <- list.files(UK_onRRT_raw_dir)
UK_files_for_FinalIDs <- UK_files[which(gsub("onRRT_raw.csv","",UK_files) %in%  UK_Final_IDs== T)]
UK_rawdata <- do.call(rbind,lapply(paste0(UK_onRRT_raw_dir,UK_files_for_FinalIDs), read.csv))
#This was excluded
UK_rawdata <- UK_rawdata[,-which(colnames(UK_rawdata) %in% c("onRRT","Record_Time","FIO2","PH","PO2","onMV"))]
#####Load static data MIMIC3
UK_static_data <- read.csv(paste0(UK_data_dir,"final_demo_df.csv"),stringsAsFactors = F)
UK_static_data <- UK_static_data[,-1]
UK_static_data$ENCNTR_ID <- sapply(strsplit(UK_static_data$ENCNTR_ID,split = "_"), "[[", 1)
UK_static_data <- UK_static_data[!duplicated(UK_static_data$ENCNTR_ID),]
UK_static_data <- UK_static_data[,-which(colnames(UK_static_data) %in% c("ENCNTR_ID"))]
#Missing Rate for static
missing_count_n_UK_1 <- sapply(UK_static_data, function(x) sum(is.na(x)))
missing_perc_UK_1 <- round(missing_count_n_UK_1/nrow(UK_static_data),2)
missing_perc_UK_1
###Missing Rate for dynamic
missing_count_n_UK_2 <- sapply(UK_rawdata, function(x) sum(is.na(x)))
missing_perc_UK_2 <- round(missing_count_n_UK_2/nrow(UK_rawdata),2)
missing_perc_UK_2
length(c(missing_perc_UK_1,missing_perc_UK_2)) #21 features
mean(c(missing_perc_UK_1,missing_perc_UK_2)) #43.5%
mean(c(missing_perc_UK_2))
#MIMICs Final IDs
MIMIC3_dir <- "/Volumes/LJL_ExtPro/Data/MIMIC3/Extract_Data_AKID_Patients/Model_Data/MIMIC3_DL_input_data/onRRT/Hourly_interp/Filtered_FeatureFiles/"
MIMIC3_Data <- read.csv(paste0(MIMIC3_dir , "Final_Outcome_df.csv"),stringsAsFactors = F)
MIMIC3_IDs <- unique(sapply(strsplit(MIMIC3_Data$SUBJECT_ID,split = "_"), "[[", 1))
#### Load MIMIC 3 raw RRT
MIMIC3_onRRT_raw_dir <- "/Volumes/LJL_ExtPro/Data/MIMIC3/Extract_Data_AKID_Patients/Model_Data/Original_Sample_Data/onRRT/onRRT_raw/"
MIMIC3_files <- list.files(MIMIC3_onRRT_raw_dir)
MIMIC3_files_for_FinalIDs <- MIMIC3_files[which(gsub("onRRT_raw.csv","",MIMIC3_files) %in%  MIMIC3_IDs== T)]
MIMIC3_rawdata <- do.call(rbind,lapply(paste0(MIMIC3_onRRT_raw_dir,MIMIC3_files_for_FinalIDs), read.csv))
#exclude the 2 features that is not included
MIMIC3_rawdata <- MIMIC3_rawdata[,-which(colnames(MIMIC3_rawdata) %in% c("Temp","WBC","onRRT","Record_Time"))]
#####Load static data MIMIC3
MIMIC3_static_data <- read.csv(paste0(MIMIC3_dir,"final_demo_df.csv"),stringsAsFactors = F)
MIMIC3_static_data$SUBJECT_ID <- sapply(strsplit(MIMIC3_static_data$SUBJECT_ID,split = "_"), "[[", 1)
MIMIC3_static_data <- MIMIC3_static_data[!duplicated(MIMIC3_static_data$SUBJECT_ID),]
MIMIC3_static_data <- MIMIC3_static_data[,-which(colnames(MIMIC3_static_data) %in% c("SUBJECT_ID"))]
#Missing Rate for static
missing_count_n_MIMIC3_1 <- sapply(MIMIC3_static_data, function(x) sum(is.na(x)))
missing_perc_MIMIC3_1 <- round(missing_count_n_MIMIC3_1/nrow(MIMIC3_static_data),2)
missing_perc_MIMIC3_1
###Missing Rate for dynamic
missing_count_n_MIMIC3_2 <- sapply(MIMIC3_rawdata, function(x) sum(is.na(x)))
missing_perc_MIMIC3_2 <- round(missing_count_n_MIMIC3_2/nrow(MIMIC3_rawdata),2)
missing_perc_MIMIC3_2
length(c(missing_perc_MIMIC3_1,missing_perc_MIMIC3_2)) #19 features
mean(c(missing_perc_MIMIC3_1,missing_perc_MIMIC3_2)) #34.6%
mean(c(missing_perc_MIMIC3_2))
#Dertmine if ESRD before or AT HOSPITAL
#1. Source 1: ESRD_USRDS.csv (Gold dataset, if not in USRD, use ESRD_STATUS.csv, then manual check
#2. Source 2: ESRD_STATUS.csv
library(lubridate)
source("TAKI_Ultility.R")
#Raw data dir
raw_dir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/Taylors_Data/UKY/raw_csv_files/"
outdir <- "/Volumes/LJL_ExtPro/Data/AKI_Data/TAKI_Data_Extracted/uky/"
##########################################################################################
#1. Analysis Id before exclusion of ESRD
##########################################################################################
analysis_ID_df <-read.csv(paste0(outdir,"Final_Analysis_ID_BeforeExclusionOfESRD.csv"),stringsAsFactors = F)
analysis_ID <- unique(analysis_ID_df[,"STUDY_PATIENT_ID"])
##########################################################################################
#2. Load data
##########################################################################################
#1. Corrected Time df
All_time_df <-read.csv(paste0(outdir,"All_Corrected_Timeinfo.csv"),stringsAsFactors = F)
#2. source 1: USRDS_ESRD
USRDS_ESRD_df <-read.csv(paste0(raw_dir,"USRDS_ESRD.csv"),stringsAsFactors = F)
USRDS_ESRD_df <- USRDS_ESRD_df[-which(USRDS_ESRD_df$ESRD_DATE==""),] #remove blanks
#reformat
USRDS_ESRD_df$ESRD_DATE <- gsub("00:00:00","",USRDS_ESRD_df$ESRD_DATE)
USRDS_ESRD_df$ESRD_DATE <- gsub("0:00","",USRDS_ESRD_df$ESRD_DATE)
dash_idxes <- which(grepl("-",USRDS_ESRD_df$ESRD_DATE) == T)
USRDS_ESRD_df$ESRD_DATE[dash_idxes] <- as.character(ymd(USRDS_ESRD_df$ESRD_DATE[dash_idxes]))
slash_idxes <- which(grepl("/",USRDS_ESRD_df$ESRD_DATE) == T)
USRDS_ESRD_df$ESRD_DATE[slash_idxes] <- as.character(mdy(USRDS_ESRD_df$ESRD_DATE[slash_idxes]))
#3. source 2
ESRD_STATUS_df <-read.csv(paste0(raw_dir,"ESRD_STATUS.csv"),stringsAsFactors = F)
ESRD_STATUS_df[which(ESRD_STATUS_df == "",arr.ind = T)] <- 0
ESRD_STATUS_df[which(ESRD_STATUS_df == "Y",arr.ind = T)] <- 1
############################################################################################################
#3. Process USRDS_ESRD.csv to get before or at
############################################################################################################
ESRD_BEFORE_AT_Indicator_df1 <- as.data.frame(matrix(NA, nrow = length(analysis_ID), ncol = 3))
colnames(ESRD_BEFORE_AT_Indicator_df1) <- c("STUDY_PATIENT_ID","BEFORE_AT_ADMISSION_USRDS","SOURCE")
for (i in 1:length(analysis_ID)){
if (i %% 1000 == 0) {print(i)}
curr_id <- analysis_ID[i]
ESRD_BEFORE_AT_Indicator_df1[i,"STUDY_PATIENT_ID"] <- curr_id
#Time info
curr_time_df <- All_time_df[which(All_time_df[,"STUDY_PATIENT_ID"] == curr_id),]
curr_hosp_start <- ymd(strsplit(curr_time_df[,"Updated_HOSP_ADMIT_DATE"],split = " ")[[1]][1]) #only get ymd cuz esrd dates has no hms
#Source 1 USRD info
curr_usrd_df <- USRDS_ESRD_df[which(USRDS_ESRD_df[,"STUDY_PATIENT_ID"] == curr_id),]
curr_esrd_date <- ymd(curr_usrd_df$ESRD_DATE)
if (nrow(curr_usrd_df) != 0){ #if in USRDs
ESRD_BEFORE_AT_Indicator_df1[i,"SOURCE"]<- "in_USRDS"
if (curr_esrd_date <= curr_hosp_start) {
ESRD_BEFORE_AT_Indicator_df1[i,"BEFORE_AT_ADMISSION_USRDS"] <- 1
}else{
ESRD_BEFORE_AT_Indicator_df1[i,"BEFORE_AT_ADMISSION_USRDS"] <- 0
}
}else{
ESRD_BEFORE_AT_Indicator_df1[i,"SOURCE"]<- "notin_USRDS"
ESRD_BEFORE_AT_Indicator_df1[i,"BEFORE_AT_ADMISSION_USRDS"]<- 0
}
}
table(ESRD_BEFORE_AT_Indicator_df1$BEFORE_AT_ADMISSION_USRDS)
############################################################################################################
#4. Process ESRD_STATUS.csv to get before or at
############################################################################################################
ESRD_BEFORE_AT_Indicator_df2 <- as.data.frame(matrix(NA, nrow = length(analysis_ID), ncol = 3))
colnames(ESRD_BEFORE_AT_Indicator_df2) <- c("STUDY_PATIENT_ID","BEFORE_AT_ADMISSION_STATUS","SOURCE")
for (i in 1:length(analysis_ID)){
if (i %% 1000 == 0) {print(i)}
curr_id <- analysis_ID[i]
ESRD_BEFORE_AT_Indicator_df2[i,"STUDY_PATIENT_ID"] <- curr_id
#source 2: status table
curr_ESRD_STATUS_df <- ESRD_STATUS_df[which(ESRD_STATUS_df[,"STUDY_PATIENT_ID"] == curr_id),]
if (nrow(curr_ESRD_STATUS_df) != 0){ #if in ESRD_STATUS.csv
ESRD_BEFORE_AT_Indicator_df2[i,"SOURCE"]<- "in_STATUS_TABLE"
if (curr_ESRD_STATUS_df[,"AT_ADMISSION_INDICATOR"] == 1 | curr_ESRD_STATUS_df[,"BEFORE_INDEXED_INDICATOR"] == 1) {
ESRD_BEFORE_AT_Indicator_df2[i,"BEFORE_AT_ADMISSION_STATUS"] <- 1
}else{
ESRD_BEFORE_AT_Indicator_df2[i,"BEFORE_AT_ADMISSION_STATUS"] <- 0
}
}else{
ESRD_BEFORE_AT_Indicator_df2[i,"SOURCE"]<- "notin_STATUS_TABLE"
ESRD_BEFORE_AT_Indicator_df2[i,"BEFORE_AT_ADMISSION_STATUS"]<- 0
}
}
############################################################################################################
#5.Combine Two data source to manually check if STATUS agres USRDS
############################################################################################################
ESRD_BEFORE_AT_Indicator_df_Comb <- as.data.frame(matrix(NA, nrow = length(analysis_ID), ncol = 5))
colnames(ESRD_BEFORE_AT_Indicator_df_Comb) <- c("STUDY_PATIENT_ID","ESRD_BEFORE_AT_USRDS","ESRD_BEFORE_AT_STATUS",
"SOURCE_USRDS","SOURCE_STATUS")
for (i in 1:length(analysis_ID)){
if (i %% 1000 == 0) {print(i)}
curr_id <- analysis_ID[i]
ESRD_BEFORE_AT_Indicator_df_Comb[i,"STUDY_PATIENT_ID"] <- curr_id
#source 1: USRDs
curr_USRDs <- ESRD_BEFORE_AT_Indicator_df1[which(ESRD_BEFORE_AT_Indicator_df1[,"STUDY_PATIENT_ID"] == curr_id),]
ESRD_BEFORE_AT_Indicator_df_Comb[i,"ESRD_BEFORE_AT_USRDS"] <- curr_USRDs[,"BEFORE_AT_ADMISSION_USRDS"]
ESRD_BEFORE_AT_Indicator_df_Comb[i,"SOURCE_USRDS"] <- curr_USRDs[,"SOURCE"]
#source 2: status table
curr_status_tb <- ESRD_BEFORE_AT_Indicator_df2[which(ESRD_BEFORE_AT_Indicator_df2[,"STUDY_PATIENT_ID"] == curr_id),]
ESRD_BEFORE_AT_Indicator_df_Comb[i,"ESRD_BEFORE_AT_STATUS"] <- curr_status_tb[,"BEFORE_AT_ADMISSION_STATUS"]
ESRD_BEFORE_AT_Indicator_df_Comb[i,"SOURCE_STATUS"] <- curr_status_tb[,"SOURCE"]
}
USRD_BeforeAT <- ESRD_BEFORE_AT_Indicator_df_Comb[,"ESRD_BEFORE_AT_USRDS"]
STATUS_BeforeAT <- ESRD_BEFORE_AT_Indicator_df_Comb[,"ESRD_BEFORE_AT_STATUS"]
table(USRD_BeforeAT,STATUS_BeforeAT)
############################################################################################################
#6. Final before/AT status
#USE USRDs first, then if patient not in USRDS, use status table
############################################################################################################
Final_ESRD_BEFORE_AT_df <- as.data.frame(matrix(NA, nrow = length(analysis_ID), ncol = 2))
colnames(Final_ESRD_BEFORE_AT_df) <- c("STUDY_PATIENT_ID","ESRD_BEFORE_AT")
for (i in 1:length(analysis_ID)){
if (i %% 1000 == 0) {print(i)}
curr_id <- analysis_ID[i]
Final_ESRD_BEFORE_AT_df[i,"STUDY_PATIENT_ID"] <- curr_id
#source 1: USRDs
curr_USRDs <- ESRD_BEFORE_AT_Indicator_df1[which(ESRD_BEFORE_AT_Indicator_df1[,"STUDY_PATIENT_ID"] == curr_id),]
curr_USRDs_flag <- curr_USRDs[,"BEFORE_AT_ADMISSION_USRDS"]
curr_USRDs_source <- curr_USRDs[,"SOURCE"]
#source 2: status table
curr_status_tb <- ESRD_BEFORE_AT_Indicator_df2[which(ESRD_BEFORE_AT_Indicator_df2[,"STUDY_PATIENT_ID"] == curr_id),]
curr_status_flag <- curr_status_tb[,"BEFORE_AT_ADMISSION_STATUS"]
curr_status_source<- curr_status_tb[,"SOURCE"]
if (curr_USRDs_source == "in_USRDS"){ #as long as it is in USRDS
final_flag <- curr_USRDs_flag
}else if(curr_USRDs_source == "notin_USRDS" & curr_status_source == "in_STATUS_TABLE"){ #if not in USRDS, but in status
final_flag <- curr_status_flag
}else if (curr_USRDs_source == "notin_USRDS" & curr_status_source == "notin_STATUS_TABLE"){#if not in both, both has the same flag
final_flag <- unique(c(curr_USRDs_flag,curr_status_flag))
}else{
final_flag <- NA
}
Final_ESRD_BEFORE_AT_df[i,"ESRD_BEFORE_AT"] <- final_flag
}
table(Final_ESRD_BEFORE_AT_df$ESRD_BEFORE_AT) #7354  447
############################################################################################################
#6. Final before/AT status
#If == 1 in either one
############################################################################################################
Final_ESRD_BEFORE_AT_df <- as.data.frame(matrix(NA, nrow = length(analysis_ID), ncol = 2))
colnames(Final_ESRD_BEFORE_AT_df) <- c("STUDY_PATIENT_ID","ESRD_BEFORE_AT")
############################################################################################################
#6. Final before/AT status
#If == 1 in either one
############################################################################################################
Final_ESRD_BEFORE_AT_df <- as.data.frame(matrix(NA, nrow = length(analysis_ID), ncol = 2))
colnames(Final_ESRD_BEFORE_AT_df) <- c("STUDY_PATIENT_ID","ESRD_BEFORE_AT")
for (i in 1:length(analysis_ID)){
if (i %% 1000 == 0) {print(i)}
curr_id <- analysis_ID[i]
Final_ESRD_BEFORE_AT_df[i,"STUDY_PATIENT_ID"] <- curr_id
#source 1: USRDs
curr_USRDs <- ESRD_BEFORE_AT_Indicator_df1[which(ESRD_BEFORE_AT_Indicator_df1[,"STUDY_PATIENT_ID"] == curr_id),]
curr_USRDs_flag <- curr_USRDs[,"BEFORE_AT_ADMISSION_USRDS"]
curr_USRDs_source <- curr_USRDs[,"SOURCE"]
#source 2: status table
curr_status_tb <- ESRD_BEFORE_AT_Indicator_df2[which(ESRD_BEFORE_AT_Indicator_df2[,"STUDY_PATIENT_ID"] == curr_id),]
curr_status_flag <- curr_status_tb[,"BEFORE_AT_ADMISSION_STATUS"]
curr_status_source<- curr_status_tb[,"SOURCE"]
if (curr_USRDs_source == 1 | curr_status_source==1){
final_flag <- 1
}else{
final_flag <- 0
}
Final_ESRD_BEFORE_AT_df[i,"ESRD_BEFORE_AT"] <- final_flag
}
############################################################################################################
#check how many status_flag=1, but usrd_flag=0, and they are actually in USRDS: 51
#so the final =1 , should equal status_yes (155-51) + USRDS_yes(48+295) = 447
############################################################################################################
table(USRD_BeforeAT,STATUS_BeforeAT)
length(which(ESRD_BEFORE_AT_Indicator_df_Comb$ESRD_BEFORE_AT_STATUS== 1 &
ESRD_BEFORE_AT_Indicator_df_Comb$ESRD_BEFORE_AT_USRDS==0 &
ESRD_BEFORE_AT_Indicator_df_Comb$SOURCE_USRDS == "in_USRDS" ))
table(Final_ESRD_BEFORE_AT_df$ESRD_BEFORE_AT) #7354  447
############################################################################################################
#6. Final before/AT status
#If == 1 in either one
############################################################################################################
Final_ESRD_BEFORE_AT_df <- as.data.frame(matrix(NA, nrow = length(analysis_ID), ncol = 2))
colnames(Final_ESRD_BEFORE_AT_df) <- c("STUDY_PATIENT_ID","ESRD_BEFORE_AT")
for (i in 1:length(analysis_ID)){
if (i %% 1000 == 0) {print(i)}
curr_id <- analysis_ID[i]
Final_ESRD_BEFORE_AT_df[i,"STUDY_PATIENT_ID"] <- curr_id
#source 1: USRDs
curr_USRDs <- ESRD_BEFORE_AT_Indicator_df1[which(ESRD_BEFORE_AT_Indicator_df1[,"STUDY_PATIENT_ID"] == curr_id),]
curr_USRDs_flag <- curr_USRDs[,"BEFORE_AT_ADMISSION_USRDS"]
curr_USRDs_source <- curr_USRDs[,"SOURCE"]
#source 2: status table
curr_status_tb <- ESRD_BEFORE_AT_Indicator_df2[which(ESRD_BEFORE_AT_Indicator_df2[,"STUDY_PATIENT_ID"] == curr_id),]
curr_status_flag <- curr_status_tb[,"BEFORE_AT_ADMISSION_STATUS"]
curr_status_source<- curr_status_tb[,"SOURCE"]
if (curr_USRDs_source == 1 | curr_status_source==1){
final_flag <- 1
}else{
final_flag <- 0
}
Final_ESRD_BEFORE_AT_df[i,"ESRD_BEFORE_AT"] <- final_flag
}
table(Final_ESRD_BEFORE_AT_df$ESRD_BEFORE_AT) #7354  447
############################################################################################################
#6. Final before/AT status
#If == 1 in either one
############################################################################################################
Final_ESRD_BEFORE_AT_df <- as.data.frame(matrix(NA, nrow = length(analysis_ID), ncol = 2))
colnames(Final_ESRD_BEFORE_AT_df) <- c("STUDY_PATIENT_ID","ESRD_BEFORE_AT")
for (i in 1:length(analysis_ID)){
if (i %% 1000 == 0) {print(i)}
curr_id <- analysis_ID[i]
Final_ESRD_BEFORE_AT_df[i,"STUDY_PATIENT_ID"] <- curr_id
#source 1: USRDs
curr_USRDs <- ESRD_BEFORE_AT_Indicator_df1[which(ESRD_BEFORE_AT_Indicator_df1[,"STUDY_PATIENT_ID"] == curr_id),]
curr_USRDs_flag <- curr_USRDs[,"BEFORE_AT_ADMISSION_USRDS"]
curr_USRDs_source <- curr_USRDs[,"SOURCE"]
#source 2: status table
curr_status_tb <- ESRD_BEFORE_AT_Indicator_df2[which(ESRD_BEFORE_AT_Indicator_df2[,"STUDY_PATIENT_ID"] == curr_id),]
curr_status_flag <- curr_status_tb[,"BEFORE_AT_ADMISSION_STATUS"]
curr_status_source<- curr_status_tb[,"SOURCE"]
if (curr_USRDs_flag == 1 | curr_status_flag==1){
final_flag <- 1
}else{
final_flag <- 0
}
Final_ESRD_BEFORE_AT_df[i,"ESRD_BEFORE_AT"] <- final_flag
}
table(Final_ESRD_BEFORE_AT_df$ESRD_BEFORE_AT) #7354  447
447 -498
analysis_ID_df <-read.csv(paste0(outdir,"Final_Analysis_ID.csv"),stringsAsFactors = F)
analysis_ID <- unique(analysis_ID_df[,"STUDY_PATIENT_ID"]) #7354
which(analysis_ID %in% Final_ESRD_BEFORE_AT_df$STUDY_PATIENT_ID[which(Final_ESRD_BEFORE_AT_df$ESRD_BEFORE_AT == 1)])
length(which(analysis_ID %in% Final_ESRD_BEFORE_AT_df$STUDY_PATIENT_ID[which(Final_ESRD_BEFORE_AT_df$ESRD_BEFORE_AT == 1)]))
############################################################################################################
#check how many status_flag=1, but usrd_flag=0, and they are actually in USRDS: 51
#so the final =1 , should equal status_yes (155-51) + USRDS_yes(48+295) = 447
############################################################################################################
table(USRD_BeforeAT,STATUS_BeforeAT)
library(openxlsx)
library(data.table)
source("Recapse_Ultility.R")
#This function get unique code in original claims data
get_unique_codes <- function(claims_df,code_columns,code_source,code_type){
#claims_df <- cleaned_pharmClaims
#code_columns <- "CDE_THERA_CLS_AHFS"
#code_source <- "AHFS Therapeutic Class"
#code_type <- "Drug"
#get unique codes
unique_codes_df <- as.data.frame(unique(unlist(claims_df[,code_columns])))
colnames(unique_codes_df) <- paste0("Unique_", code_type,"_Code")
#add code source info
unique_codes_df$Code_Coumn  <- code_columns
unique_codes_df$Code_Source <- code_source
#remove NA
na_idxes <- which(is.na(unique_codes_df[,1]) == T)
unique_codes_df <- unique_codes_df[-na_idxes,]
return(unique_codes_df)
}
################################################################################
#Data dir
################################################################################
#on HPC
data_dir <- "/recapse/data/Testing data for UH3 - Dec 16 2020/"
outdir <- "/recapse/intermediate_data/2_Codes_And_Groups/"
#local
data_dir <- "/Volumes/LJL_ExtPro/Data/Testing data for UH3 - Dec 16 2020/"
outdir <- "/Users/lucasliu/Desktop/DrChen_Projects/ReCAPSE_Project/ReCAPSE_Intermediate_Data/0610_21/2_Codes_And_Groups/"
################################################################################
#3.Load claims from medicare
################################################################################
#1.Load cliams
medicaid_health_df <- as.data.frame(fread(paste0(data_dir,"kcr_medicaid_healthclaims_fb0015.csv")))
medicaid_pharm_df <- as.data.frame(fread(paste0(data_dir,"KCR_MEDICAID_PHARMCLAIMS_FB0015.csv")))
#2. Codes columns for medicaid
medicaid_diag_cols <- c("CDE_DIAG_PRIM","CDE_DIAG_2","CDE_DIAG_3","CDE_DIAG_4")
medicaid_proc_cols <- c("CDE_PROC_PRIM")
medicaid_drug_cols <- c("CDE_THERA_CLS_AHFS","CDE_NDC")
#3.Clean code
cleaned_healthClaims <- clean_code_columns(medicaid_health_df,c(medicaid_diag_cols,medicaid_proc_cols))
cleaned_pharmClaims <-  clean_code_columns(medicaid_pharm_df,medicaid_drug_cols)
#4.Get unique code
unique_Diag_ICD_df <- get_unique_codes(cleaned_healthClaims,medicaid_diag_cols,"ICD","Diag")
unique_Proc_HCPCS_df <- get_unique_codes(cleaned_healthClaims,"CDE_PROC_PRIM","HCPCS","Proc")
unique_drug_AHFS_df <- get_unique_codes(cleaned_pharmClaims,"CDE_THERA_CLS_AHFS","AHFS","Drug")
unique_drug_NDC_df <- get_unique_codes(cleaned_pharmClaims,"CDE_NDC","NDC","Drug")
#3.Clean code
cleaned_healthClaims <- clean_code_columns(medicaid_health_df,c(medicaid_diag_cols,medicaid_proc_cols))
library(openxlsx)
library(data.table)
source("Recapse_Ultility.R")
setwd("~/Desktop/DrChen_Projects/ReCAPSE_Project/ReCAPSE_Code/onHPC")
library(openxlsx)
library(data.table)
source("Recapse_Ultility.R")
#3.Clean code
cleaned_healthClaims <- clean_code_columns(medicaid_health_df,c(medicaid_diag_cols,medicaid_proc_cols))
cleaned_pharmClaims <-  clean_code_columns(medicaid_pharm_df,medicaid_drug_cols)
#4.Get unique code
unique_Diag_ICD_df <- get_unique_codes(cleaned_healthClaims,medicaid_diag_cols,"ICD","Diag")
unique_Proc_HCPCS_df <- get_unique_codes(cleaned_healthClaims,"CDE_PROC_PRIM","HCPCS","Proc")
unique_drug_AHFS_df <- get_unique_codes(cleaned_pharmClaims,"CDE_THERA_CLS_AHFS","AHFS","Drug")
unique_drug_NDC_df <- get_unique_codes(cleaned_pharmClaims,"CDE_NDC","NDC","Drug")
View(unique_Diag_ICD_df)
unique_drug_df2A <- get_unique_codes(cleaned_pharmClaims,"CDE_THERA_CLS_AHFS","AHFS","Drug")
unique_drug_df2B <- get_unique_codes(cleaned_pharmClaims,"CDE_NDC","NDC","Drug")
View(unique_drug_df2B)
Final_unique_diag <- rbind(unique_Diag_df2,unique_Diag_df2)
#4.Get unique code
unique_Diag_df2 <- get_unique_codes(cleaned_healthClaims,medicaid_diag_cols,"ICD","Diag")
Final_unique_diag <- rbind(unique_Diag_df2,unique_Diag_df2)
Final_unique_diag <- rbind(unique(unique_Diag_df2,unique_Diag_df2))
View(Final_unique_diag)
Final_unique_diag <- unique(rbind(unique_Diag_df2,unique_Diag_df2))
View(Final_unique_diag)
Final_unique_diag <- rbind(unique_Diag_df2,unique_Diag_df2)
Final_unique_diag <- Final_unique_diag[!duplicated(Final_unique_diag[,"Unique_Diag_Code"]),]
duplicated(Final_unique_diag[,"Unique_Diag_Code"])
outdir
################################################################################
#2.Load claims from medicare
################################################################################
#1.Load cliams
medicare_claims_df <- as.data.frame(fread(paste0(data_dir,"kcr_medicare_claims_fb0015.csv",nrows = 100)))
#local
data_dir <- "/Volumes/LJL_ExtPro/Data/Testing data for UH3 - Dec 16 2020/"
outdir <- "/Users/lucasliu/Desktop/DrChen_Projects/ReCAPSE_Project/ReCAPSE_Intermediate_Data/0610_21/2_Codes_And_Groups/"
################################################################################
#2.Load claims from medicare
################################################################################
#1.Load cliams
medicare_claims_df <- as.data.frame(fread(paste0(data_dir,"kcr_medicare_claims_fb0015.csv",nrows = 100)))
################################################################################
#2.Load claims from medicare
################################################################################
#1.Load cliams
medicare_claims_df <- as.data.frame(fread(paste0(data_dir,"kcr_medicare_claims_fb0015.csv"),nrows = 100))
#2.Codes columns for medicare
medicare_diag_cols <- paste0("DGNS_CD",seq(1,25))
medicare_proc_cols <- c(paste0("PRCDRCD",seq(1,25)),"HCPCS_CD")
medicare_drug_cols <- c("NDC_CD","PROD_SRVC_ID")
#3.Clean codes
cleaned_medicareClaims_df <- clean_code_columns(medicare_claims_df,c(medicare_diag_cols,medicare_proc_cols,medicare_drug_cols))
#4.Get unique code
unique_Diag_df1 <- get_unique_codes(cleaned_medicareClaims_df,medicare_diag_cols,"ICD","Diag")
cleaned_medicareClaims_df
claims_df <- cleaned_medicareClaims_df
code_columns <- medicare_diag_cols
code_source <- "ICD"
code_type <- "Diag"
#get unique codes
unique_codes_df <- as.data.frame(unique(unlist(claims_df[,code_columns])))
colnames(unique_codes_df) <- paste0("Unique_", code_type,"_Code")
#add code source info
unique_codes_df$Code_Coumn  <- code_columns
code_columns
#add code source info
unique_codes_df$Code_Coumn  <- paste0(code_columns,collapse = "#")
unique_codes_df$Code_Coumn
#add code source info
unique_codes_df$Code_Coumn  <- paste0(code_columns,collapse = "$$$$")
unique_codes_df$Code_Coumn
code_columns
################################################################################
#3.Load claims from medicare
################################################################################
#1.Load cliams
medicaid_health_df <- as.data.frame(fread(paste0(data_dir,"kcr_medicaid_healthclaims_fb0015.csv")))
#4.Get unique code
unique_Diag_df2 <- get_unique_codes(cleaned_healthClaims,medicaid_diag_cols,"ICD","Diag")
View(unique_Diag_df2)
medicaid_diag_cols
#add code source info
gsub("[[:digit:]]","",code_columns)
code_columns
#add code source info
gsub("[[:digit:]]","",code_columns)
#add code source info
unique(gsub("[[:digit:]]","",code_columns))
#This function get unique code in original claims data
get_unique_codes <- function(claims_df,code_columns,code_source,code_type){
# claims_df <- cleaned_medicareClaims_df
# code_columns <- medicare_diag_cols
# code_source <- "ICD"
# code_type <- "Diag"
#get unique codes
unique_codes_df <- as.data.frame(unique(unlist(claims_df[,code_columns])))
colnames(unique_codes_df) <- paste0("Unique_", code_type,"_Code")
#add code source info
unique_codes_df$Code_Coumn  <-  paste0(unique(gsub("[[:digit:]]","",code_columns)),collapse = "$$$$")
unique_codes_df$Code_Source <- code_source
#remove NA
na_idxes <- which(is.na(unique_codes_df[,1]) == T)
unique_codes_df <- unique_codes_df[-na_idxes,]
return(unique_codes_df)
}
#4.Get unique code
unique_Diag_df2 <- get_unique_codes(cleaned_healthClaims,medicaid_diag_cols,"ICD","Diag")
#4.Get unique code
unique_Diag_df1 <- get_unique_codes(cleaned_medicareClaims_df,medicare_diag_cols,"ICD","Diag")
unique_Proc_df1A <- get_unique_codes(cleaned_medicareClaims_df,paste0("PRCDRCD",seq(1,25)),"ICD","Proc")
unique_Proc_df1B <- get_unique_codes(cleaned_medicareClaims_df,"HCPCS_CD","HCPCs","Proc")
unique_Drug_df1 <- get_unique_codes(cleaned_medicareClaims_df,medicare_drug_cols,"NDC","Drug")
View(unique_Diag_df1)
unique_Proc_df2 <- get_unique_codes(cleaned_healthClaims,"CDE_PROC_PRIM","HCPCS","Proc")
unique_drug_df2A <- get_unique_codes(cleaned_pharmClaims,"CDE_THERA_CLS_AHFS","AHFS","Drug")
unique_drug_df2B <- get_unique_codes(cleaned_pharmClaims,"CDE_NDC","NDC","Drug")
View(unique_Proc_df2)
################################################################################
#4.Combine all unique codes
################################################################################
#Combine both
Final_diag <- rbind(unique_Diag_df1,unique_Diag_df2)
Final_unique_diag <- Final_diag[!duplicated(Final_diag[,"Unique_Diag_Code"]),]
Final_proc <- rbind(unique_Proc_df1A,unique_Proc_df1B,unique_Proc_df2)
Final_unique_proc <- Final_proc[!duplicated(Final_proc[,"Unique_Proc_Code"]),]
Final_drug <- rbind(unique_Drug_df1,unique_drug_df2A,unique_drug_df2B)
Final_unique_drug <- Final_drug[!duplicated(Final_drug[,"Unique_Drug_Code"]),]
unique_drug_df2A
unique_Drug_df1
write.xlsx(Final_unique_drug,paste0(outdir,"Unique_Drug_Codes.xlsx"))
